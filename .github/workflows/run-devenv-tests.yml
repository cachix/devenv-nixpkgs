name: Run devenv tests

on:
  workflow_dispatch:
    inputs:
      nixpkgs-input:
        description: "Nixpkgs input to use"
        required: false
        default: "github:cachix/devenv-nixpkgs/bump-rolling"
        type: string
  workflow_call:
    inputs:
      nixpkgs-input:
        description: "Nixpkgs input to use"
        required: false
        default: "github:cachix/devenv-nixpkgs/bump-rolling"
        type: string

jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: [self-hosted, linux, ARM64]
            system: aarch64-linux
          - os: [self-hosted, linux, X64]
            system: x86_64-linux
          - os: [self-hosted, macOS, ARM64]
            system: aarch64-darwin
          - os: [macos-15-intel]
            system: x86_64-darwin
    uses: cachix/devenv/.github/workflows/test.yml@main
    with:
      system: ${{ matrix.system }}
      runs-on: ${{ toJSON(matrix.os) }}
      nixpkgs-input: ${{ inputs.nixpkgs-input }}
    secrets: inherit

  examples:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: [self-hosted, linux, ARM64]
            system: aarch64-linux
          - os: [self-hosted, linux, X64]
            system: x86_64-linux
          - os: [self-hosted, macOS, ARM64]
            system: aarch64-darwin
          - os: [macos-15-intel]
            system: x86_64-darwin
    uses: cachix/devenv/.github/workflows/examples.yml@main
    with:
      system: ${{ matrix.system }}
      runs-on: ${{ toJSON(matrix.os) }}
      nixpkgs-input: ${{ inputs.nixpkgs-input }}
    secrets: inherit