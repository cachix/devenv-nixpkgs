name: Fetch upstream and apply patches

on:
  workflow_dispatch:
    inputs:
      target-branch:
        description: "Target branch to create/update"
        required: false
        default: "bump-rolling"
        type: string
      upstream-ref:
        description: "Upstream nixpkgs ref to sync from"
        required: false
        default: "nixpkgs-unstable"
        type: string
  workflow_call:
    inputs:
      target-branch:
        description: "Target branch to create/update"
        required: false
        default: "bump-rolling"
        type: string
      upstream-ref:
        description: "Upstream nixpkgs ref to sync from"
        required: false
        default: "nixpkgs-unstable"
        type: string

permissions:
  contents: write # Push commits

jobs:
  fetch-and-patch:
    runs-on: [self-hosted, Linux]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name 'GitHub Actions Bot'
          git config user.email 'actions@github.com'

      - name: Copy patches to temp directory
        run: cp -R patches "$RUNNER_TEMP"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/NixOS/nixpkgs.git || true
          git fetch upstream

      - name: Create fresh branch from upstream
        run: |
          git checkout -B ${{ inputs.target-branch }} upstream/${{ inputs.upstream-ref }}

      - name: Remove nixpkgs workflows
        run: |
          rm -rf .github
          git add -A
          git commit -m "ci: remove nixpkgs workflows"

      - name: Apply patches
        run: |
          for patch in $RUNNER_TEMP/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying patch: $patch"
              if ! git am "$patch"; then
                echo "Failed to apply patch: $patch"
                exit 1
              fi
            fi
          done

      - name: Push branch
        run: git push -f origin ${{ inputs.target-branch }}